import pickle
import time

import serial

heartrate = ['365', '369', '370', '365', '358', '351', '344', '340', '343', '345', '350', '357', '365', '369', '370',
             '365', '358', '351', '344', '340', '343', '345', '350', '357', '365', '369', '370', '365', '358', '351',
             '344', '340', '360', '352', '345', '340', '337', '336', '337', '338', '340', '342', '344', '345', '346',
             '346', '345', '344', '342', '341', '341', '341', '340', '340', '340', '340', '340', '341', '342', '342',
             '343', '342', '342', '342', '342', '342', '342', '342', '343', '343', '347', '352', '360', '367', '369',
             '366', '361', '353', '346', '341', '338', '336', '336', '338', '339', '343', '344', '346', '347', '347',
             '346', '344', '342', '341', '340', '339', '339', '339', '340', '340', '340', '342', '342', '342', '343',
             '343', '343', '343', '343', '342', '342', '342', '342', '344', '348', '354', '362', '368', '368', '365',
             '359', '351', '345', '340', '336', '335', '336', '338', '341', '343', '346', '347', '347', '347', '345',
             '344', '342', '341', '339', '339', '339', '339', '340', '340', '341', '342', '343', '343', '343', '343',
             '343', '343', '343', '343', '342', '342', '342', '345', '350', '357', '364', '368', '368', '364', '357',
             '349', '342', '338', '335', '334', '335', '338', '341', '344', '347', '349', '349', '348', '346', '344',
             '343', '341', '340', '340', '340', '339', '341', '342', '343', '343', '344', '343', '343', '343', '344',
             '344', '344', '348', '355', '362', '367', '369', '365', '360', '352', '344', '339', '335', '334', '335',
             '337', '340', '343', '346', '349', '349', '348', '346', '344', '342', '340', '339', '339', '338', '340',
             '340', '341', '342', '343', '344', '343', '344', '344', '344', '342', '344', '349', '356', '364', '368',
             '368', '364', '357', '350', '343', '338', '336', '335', '337', '338', '341', '344', '346', '347', '347',
             '347', '346', '344', '343', '341', '341', '340', '340', '340', '341', '341', '341', '343', '343', '344',
             '343', '344', '343', '343', '343', '345', '350', '357', '364', '367', '367', '362', '356', '349', '342',
             '339', '336', '336', '337', '340', '342', '344', '346', '347', '347', '346', '345', '343', '342', '341',
             '340', '339', '340', '340', '341', '341', '342', '343', '343', '344', '343', '343', '343', '343', '342',
             '342', '343', '347', '352', '359', '365', '368', '366', '361', '354', '348', '342', '338', '336', '336',
             '338', '340', '344', '346', '348', '349', '349', '347', '344', '342', '341', '340', '339', '341', '341',
             '341', '343', '344', '344', '343', '344', '343', '343', '343', '343', '342', '343', '345', '350', '358',
             '365', '368', '367', '362', '354', '347', '342', '338', '337', '337', '339', '340', '343', '345', '346',
             '347', '346', '346', '344', '342', '341', '341', '340', '340', '340', '341', '341', '342', '342', '343',
             '343', '343', '343', '343', '343', '343', '343', '342', '343', '346', '353', '360', '365', '367', '366',
             '359', '352', '344', '339', '336', '335', '336', '338', '341', '343', '345', '346', '347', '347', '346',
             '345', '342', '340', '340', '339', '340', '340', '341', '341', '342', '342', '342', '343', '344', '343',
             '343', '343', '343', '343', '343', '342', '343', '345', '351', '358', '364', '366', '364', '360', '353',
             '346', '341', '337', '335', '335', '337', '340', '343', '345', '347', '348', '348', '345', '344', '342',
             '340', '339', '339', '339', '340', '341', '341', '342', '342', '343', '343', '343', '343', '343', '343',
             '343', '343', '343', '342', '345', '350', '356', '362', '365', '364', '361', '355', '348', '341', '338',
             '335', '335', '336', '339', '342', '345', '347', '348', '347', '347', '344', '342', '341', '340', '340',
             '339', '340', '341', '341', '342', '342', '342', '343', '343', '343', '343', '343', '343', '343', '344',
             '349', '354', '360', '365', '365', '362', '357', '352', '345', '341', '339', '337', '338', '340', '342',
             '344', '345', '346', '346', '345', '344', '344', '342', '341', '340', '340', '340', '340', '341', '341',
             '341', '342', '342', '343', '343', '343', '343', '343', '343', '343', '343', '345', '348', '353', '359',
             '363', '364', '361', '356', '352', '346', '342', '340', '339', '339', '340', '342', '344', '344', '345',
             '346', '345', '344', '343', '342', '341', '341', '340', '341', '341', '341', '342', '342', '342', '342',
             '343', '343', '343', '343', '343', '342', '342', '342', '343', '345', '348', '352', '357', '358', '358',
             '356', '351', '347', '344', '341', '340', '340', '340', '341', '343', '344', '345', '346', '345', '345',
             '344', '342', '342', '341', '342', '341', '340', '341', '341', '342', '342', '342', '342', '344', '343',
             '343', '343', '342', '343', '343', '344', '347', '351', '354', '357', '357', '355', '352', '349', '346',
             '343', '342', '342', '342', '342', '343', '344', '345', '345', '345', '345', '344', '344', '343', '342',
             '342', '342', '342', '342', '342', '342', '343', '343', '343', '343', '344', '344', '344', '344', '344',
             '343', '343', '343', '343', '344', '347', '351', '354', '358', '359', '358', '356', '352', '349', '346',
             '344', '344', '344', '344', '345', '346', '346', '346', '346', '346', '344', '344', '343', '342', '342',
             '343', '342', '342', '343', '343', '343', '343', '344', '344', '344', '344', '343', '343', '343', '343',
             '343', '344', '343', '343', '343', '344', '346', '351', '357', '364', '367', '367', '364', '358', '352',
             '347', '342', '340', '339', '340', '341', '342', '344', '346', '346', '346', '346', '345', '343', '341',
             '341', '341', '340', '341', '341', '341', '342', '342', '343', '343', '343', '343', '344', '343', '343',
             '342', '342', '343', '342', '342', '342', '343', '345', '350', '356', '363', '369', '370', '366', '360',
             '351', '346', '342', '338', '337', '338', '339', '342', '344', '346', '348', '348', '347', '346', '344',
             '342', '341', '340', '340', '341', '341', '342', '342', '342', '343', '342', '343', '343', '343', '342',
             '343', '343', '342', '342', '344', '348', '355', '363', '367', '369', '366', '359', '352', '345', '340',
             '338', '337', '338', '339', '342', '345', '346', '347', '348', '346', '346', '344', '342', '341', '340',
             '340', '340', '341', '341', '341', '342', '342', '343', '343', '343', '343', '343', '343', '343', '343',
             '342', '342', '343', '345', '350', '358', '364', '368', '367', '362', '355', '347', '342', '338', '336',
             '336', '338', '340', '343', '345', '346', '348', '348', '347', '345', '343', '341', '340', '340', '340',
             '340', '340', '341', '341', '342', '343', '343', '344', '344', '343', '344', '344', '343', '342', '343',
             '342', '344', '347', '352', '361', '365', '368', '365', '359', '351', '345', '339', '336', '335', '336',
             '337', '340', '343', '346', '348', '348', '348', '347', '344', '343', '341', '340', '340', '340', '339',
             '340', '340', '341', '342', '343', '343', '343', '343', '343', '343', '343', '343', '343', '342', '342',
             '346', '350', '357', '363', '366', '366', '361', '355', '347', '342', '338', '336', '335', '337', '339',
             '342', '345', '348', '349', '349', '348', '346', '343', '342', '340', '339', '340', '339', '340', '341',
             '341', '342', '342', '343', '343', '344', '344', '344', '344', '344', '343', '344', '347', '353', '360',
             '365', '366', '364', '359', '352', '346', '340', '337', '334', '335', '337', '340', '345', '347', '349',
             '350', '349', '347', '345', '343', '341', '340', '340', '339', '340', '341', '341', '342', '343', '343',
             '344', '344', '344', '343', '344', '346', '351', '357', '363', '367', '366', '361', '355', '348', '342',
             '338', '336', '336', '338', '340', '343', '346', '348', '349', '348', '347', '345', '343', '341', '341',
             '340', '339', '340', '340', '341', '342', '343', '343', '344', '344', '344', '343', '343', '342', '343',
             '344', '348', '354', '361', '367', '367', '363', '358', '351', '345', '339', '337', '336', '337', '340',
             '341', '344', '346', '347', '348', '347', '345', '344', '343', '340', '340', '340', '340', '340', '340',
             '342', '341', '343', '344', '344', '343', '344', '343', '343', '343', '342', '342', '343', '345', '351',
             '358', '364', '366', '364', '360', '353', '347', '341', '338', '336', '337', '338', '340', '343', '345',
             '347', '348', '347', '346', '345', '342', '341', '340', '340', '340', '340', '342', '342', '342', '343',
             '344', '344', '344', '344', '344', '345', '344', '343', '343', '346', '349', '355', '360', '364', '363',
             '360', '354', '347', '342', '339', '337', '336', '338', '341', '343', '345', '346', '348', '346', '346',
             '344', '343', '341', '340', '341', '340', '340', '341', '341', '341', '342', '343', '343', '344', '344',
             '344', '343', '344', '343', '342', '343', '343', '346', '352', '359', '365', '367', '365', '361', '355',
             '349', '343', '340', '339', '338', '339', '341', '343', '344', '345', '346', '346', '345', '344', '343',
             '342', '340', '341', '340', '341', '341', '341', '342', '343', '343', '344', '343', '343', '343', '343',
             '343', '343', '343', '342', '342', '342', '342', '343', '346', '352', '359', '366', '370', '368', '363',
             '356', '349', '343', '339', '337', '337', '338', '340', '343', '346', '347', '348', '348', '347', '346',
             '345', '343', '342', '341', '342', '342', '341', '341', '342', '342', '343', '342', '343', '342', '342',
             '341', '342', '341', '342', '342', '343', '342', '342', '343', '347', '352', '361', '366', '369', '367',
             '361', '352', '346', '340', '337', '335', '336', '338', '341', '343', '346', '347', '348', '348', '346',
             '344', '342', '341', '340', '339', '339', '339', '340', '341', '342', '342', '343', '343', '344', '344',
             '343', '343', '342', '343', '342', '342', '342', '342', '342', '343', '346', '353', '360', '366', '368',
             '366', '361', '354', '347', '341', '338', '336', '336', '337', '340', '344', '347', '349', '348', '348',
             '347', '345', '343', '341', '339', '339', '340', '339', '340', '341', '342', '343', '343', '343', '344',
             '344', '344', '344', '343', '343', '343', '343', '346', '351', '359', '365', '366', '364', '360', '352',
             '346', '341', '338', '336', '336', '338', '340', '342', '345', '347', '348', '348', '347', '344', '344',
             '343', '341', '341', '340', '340', '341', '341', '341', '343', '344', '343']


def mock_heartrate():
    ser = serial.Serial("COM4", 115200, timeout=1)
    last_ten = []
    avg_bmps = []
    count = 0
    avg = 0
    ok = True
    now = time.perf_counter()
    then = now
    i = 0
    count = 0
    ok = True
    now = time.perf_counter()
    while True:
        ser.write(heartrate[i].encode() + "\n".encode())
        data = int(heartrate[i])
        # serW.write(response.encode() + b'\n')
        if len(last_ten) >= 50:
            last_ten.pop(0)
        last_ten.append(data)
        avg = int(sum(last_ten) / len(last_ten))
        if ok and data >= avg + 3:
            then = now
            now = time.perf_counter()
            if int(60 / (now - then)) > 220:
                continue
            count += 1
            print("heartbeat", count)
            if len(avg_bmps) >= 60:
                avg_bmps.pop(0)
            avg_bmps.append(60 / (now - then))
            print(60 / (now - then))
            print("avg", sum(avg_bmps) / len(avg_bmps))
            ok = False
        elif not ok:
            now = time.perf_counter()
            if int(60 / (now - then)) < 220 and data <= avg + 3:
                ok = True
        # if ok and data >= avg + 3:
        #     then = now
        #     now = time.perf_counter()
        #     count += 1
        #     print("heartbeat", count)
        #     print(60 / (now - then))
        #     ok = False
        # if not ok and data <= avg + 3:
        #     ok = True
        # if len(last_ten) >= 10:
        #     last_ten.pop(0)
        # last_ten.append(data)
        # avg = sum(last_ten) / len(last_ten)
        i += 1
        if i == len(heartrate):
            i = 0
        time.sleep(0.02)


def record():
    data_ = []
    ser = serial.Serial("COM3", 115200, timeout=1)
    start = time.perf_counter()
    try:
        while time.perf_counter() - start < 30:
            response = ser.readline().decode("utf-8").strip()
            if response:
                data = response.split(",")[-1]
                data_.append(data)
        with open("data.txt", "wb") as f:
            pickle.dump(data_, f)
        print(data_)
    finally:
        ser.close()


# def get_bpm():
#     ser = serial.Serial("COM3", 115200, timeout=1)
#     serW = serial.Serial("COM4", 115200, timeout=1)
#     last_ten = []
#     count = 0
#     avg = 0
#     ok = True
#     now = time.perf_counter()
#     then = now
#     try:
#         while True:
#             response = ser.readline().decode("utf-8").strip()
#             if response:
#                 data = response.split(",")[-1]
#                 serW.write(data.encode() + "\n".encode())
#                 time.sleep(0.02)
#                 data = int(data)
#                 if len(last_ten) >= 10:
#                     last_ten.pop(0)
#                 else:
#                     if len(last_ten) == 0:
#                         last_ten.append(data)
#                     else:
#                         last_ten.append(data)
#                 avg = int(sum(last_ten) / len(last_ten))
#                 if ok and data >= avg + 3:
#                     then = now
#                     now = time.perf_counter()
#                     count += 1
#                     print("heartbeat", count)
#                     print(60 / (now - then))
#                     ok = False
#                 if not ok and data <= avg + 3:
#                     ok = True
#                     last_ten.append(data)
#                 # if avg == 0:
#                 #     avg = data
#                 # avg = int((avg + data)/2)
#                 # print(avg)
#                 # if ok:
#                 #     if 450 > int(data) >= avg + 2 > 350:
#                 #         then = now
#                 #         now = time.perf_counter()
#                 #         count += 1
#                 #         print("heartbeat", count)
#                 #         print(60 / (now - then))
#                 #         ok = False
#                 # else:
#                 #     now = time.perf_counter()
#                 #     if ok and int(data) <= avg + 2:
#                 #         ok = True
#                 #     if (now - then) > 3:
#                 #         ok = True
#     finally:
#         ser.close()

def get_bpm():
    ser = serial.Serial("COM3", 115200, timeout=1)
    serW = serial.Serial("COM4", 115200, timeout=1)
    avg_bmps = []
    last_ten = []
    count = 0
    avg = 0
    ok = True
    now = time.perf_counter()
    then = now
    try:
        while True:
            response = ser.readline().decode("utf-8").strip()
            if response:
                data = int(response.split(",")[-1])
                serW.write(response.encode() + b'\n')
                if len(last_ten) >= 50:
                    last_ten.pop(0)
                last_ten.append(data)
                avg = int(sum(last_ten) / len(last_ten))
                if ok and data >= avg + 3:
                    then = now
                    now = time.perf_counter()
                    if int(60 / (now - then)) > 220:
                        continue
                    count += 1
                    print("heartbeat", count)
                    if len(avg_bmps) >= 60:
                        avg_bmps.pop(0)
                    avg_bmps.append(60 / (now - then))
                    print(60 / (now - then))
                    print("avg", sum(avg_bmps) / len(avg_bmps))
                    ok = False
                elif not ok:
                    now = time.perf_counter()
                    if int(60 / (now - then)) < 220 and data <= avg + 3:
                        ok = True
    finally:
        ser.close()


def get_bpm_chat():
    ser = serial.Serial("COM3", 115200, timeout=1)
    serW = serial.Serial("COM4", 115200, timeout=1)
    last_ten = []
    count = 0
    avg = 0
    ok = True
    now = time.perf_counter()
    then = now
    try:
        while True:
            response = ser.readline().decode("utf-8").strip()
            if response:
                data = int(response.split(",")[-1])
                serW.write(response.encode() + b'\n')
                if ok and data >= avg + 3:
                    then = now
                    now = time.perf_counter()
                    count += 1
                    print("heartbeat", count)
                    print(60 / (now - then))
                    ok = False
                if not ok and data <= avg + 3:
                    ok = True
                if len(last_ten) >= 10:
                    last_ten.pop(0)
                last_ten.append(data)
                avg = sum(last_ten) / len(last_ten)
    finally:
        ser.close()


if __name__ == '__main__':
    # mock_heartrate()
    get_bpm()
